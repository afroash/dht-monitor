name: Deploy Server to Production

on:
  push:
    branches: [main]
    paths:
      - 'cmd/server/**'
      - 'internal/**'
      - 'web/**'
      - 'configs/server.yaml'
      - '.github/workflows/deploy-server.yml'
  workflow_dispatch:  # Allow manual trigger

jobs:
  deploy:
    name: Build and Deploy to Lightsail
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ›ï¸ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ¹ Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: ğŸ”§ Build Server Binary
        run: |
          cd cmd/server
          GOOS=linux GOARCH=amd64 go build -o dht-server -ldflags="-s -w" .
          chmod +x dht-server
          ls -lh dht-server

      - name: ğŸ“¦ Prepare Deployment Package
        run: |
          mkdir -p deploy/bin
          mkdir -p deploy/web/templates
          cp cmd/server/dht-server deploy/bin/
          cp web/templates/dashboard.html deploy/web/templates/

      - name: ğŸ”‘ Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

      # ============================================
      # Phase 3B: Infrastructure Setup
      # ============================================
      - name: ğŸ—„ï¸ Setup Database Directory (Phase 3B)
        run: |
          echo "Setting up SQLite database directory..."
          ssh -i ~/.ssh/deploy_key ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} \
            "sudo mkdir -p /var/lib/dht-monitor && \
             sudo chown dht-monitor:dht-monitor /var/lib/dht-monitor && \
             sudo chmod 750 /var/lib/dht-monitor"
          
          echo "âœ… Database directory configured: /var/lib/dht-monitor"

      - name: ğŸ”§ Update Systemd Service (Phase 3B)
        run: |
          echo "Updating systemd service with SQLite support..."
          
          # Create updated service file
          cat > /tmp/dht-server.service << 'EOF'
          [Unit]
          Description=DHT Monitor Server
          After=network.target
          Wants=cloudflared.service

          [Service]
          Type=simple
          User=dht-monitor
          Group=dht-monitor
          WorkingDirectory=/opt/dht-monitor
          ExecStart=/opt/dht-monitor/bin/dht-server --config /opt/dht-monitor/configs/server.yaml
          Restart=always
          RestartSec=5
          StandardOutput=journal
          StandardError=journal
          SyslogIdentifier=dht-server

          # Security
          NoNewPrivileges=true
          PrivateTmp=true
          ProtectSystem=strict
          ProtectHome=true
          ReadWritePaths=/opt/dht-monitor/data /opt/dht-monitor/logs /var/lib/dht-monitor

          # State Directory (for SQLite database)
          StateDirectory=dht-monitor
          StateDirectoryMode=0750

          # Environment
          Environment="SERVER_AUTH_TOKEN=REPLACE_ME_VIA_ENV_FILE"
          Environment="ENV=production"

          [Install]
          WantedBy=multi-user.target
          EOF
          
          # Deploy updated service file
          scp -i ~/.ssh/deploy_key /tmp/dht-server.service \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:/tmp/
          
          ssh -i ~/.ssh/deploy_key ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} \
            "sudo mv /tmp/dht-server.service /etc/systemd/system/dht-server.service && \
             sudo systemctl daemon-reload"
          
          echo "âœ… Systemd service updated and reloaded"

      # ============================================
      # Standard Deployment Steps
      # ============================================
      - name: ğŸš€ Deploy to Server
        run: |
          echo "Deploying to ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}"
          
          # Stop service before replacing binary
          ssh -i ~/.ssh/deploy_key ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} \
            "sudo systemctl stop dht-server || true"
          
          # Deploy binary
          scp -i ~/.ssh/deploy_key cmd/server/dht-server \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:/tmp/dht-server
          
          ssh -i ~/.ssh/deploy_key ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} \
            "sudo mv /tmp/dht-server /opt/dht-monitor/bin/dht-server && \
             sudo chown dht-monitor:dht-monitor /opt/dht-monitor/bin/dht-server && \
             sudo chmod 755 /opt/dht-monitor/bin/dht-server"
          
          # Deploy web assets
          scp -i ~/.ssh/deploy_key -r web/templates/* \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:/tmp/
          
          ssh -i ~/.ssh/deploy_key ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} \
            "sudo cp /tmp/dashboard.html /opt/dht-monitor/web/templates/ && \
             sudo chown -R dht-monitor:dht-monitor /opt/dht-monitor/web"

      - name: ğŸ”§ Configure Environment
        run: |
          ssh -i ~/.ssh/deploy_key ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} \
            "echo 'SERVER_AUTH_TOKEN=${{ secrets.SERVER_AUTH_TOKEN }}' | \
             sudo tee /opt/dht-monitor/.env > /dev/null && \
             sudo chmod 600 /opt/dht-monitor/.env && \
             sudo chown dht-monitor:dht-monitor /opt/dht-monitor/.env"

      - name: â˜ï¸ Ensure Cloudflare Tunnel is Running
        run: |
          ssh -i ~/.ssh/deploy_key ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} \
            "sudo systemctl is-active cloudflared || sudo systemctl start cloudflared"

      - name: ğŸ”„ Start DHT Server
        run: |
          ssh -i ~/.ssh/deploy_key ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} \
            "sudo systemctl start dht-server && \
             sudo systemctl enable dht-server"

      - name: â³ Wait for Service
        run: sleep 10

      - name: ğŸ—„ï¸ Verify Database Created (Phase 3B)
        run: |
          echo "Checking database initialization..."
          ssh -i ~/.ssh/deploy_key ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} \
            "if [ -f /var/lib/dht-monitor/dht.db ]; then \
               echo 'âœ… Database created successfully'; \
               sudo ls -lh /var/lib/dht-monitor/dht.db; \
             else \
               echo 'âš ï¸ Database not yet created (will be created on first reading)'; \
             fi"

      - name: ğŸ¥ Health Check
        run: |
          echo "Checking service status..."
          ssh -i ~/.ssh/deploy_key ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} \
            "sudo systemctl status dht-server --no-pager"
          
          echo "Testing health endpoint..."
          MAX_RETRIES=5
          RETRY_COUNT=0
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            if curl -f -m 10 https://dht.afroash.com/health; then
              echo "âœ… Health check passed!"
              exit 0
            fi
            RETRY_COUNT=$((RETRY_COUNT + 1))
            echo "Retry $RETRY_COUNT/$MAX_RETRIES..."
            sleep 5
          done
          
          echo "âŒ Health check failed after $MAX_RETRIES attempts"
          exit 1

      - name: ğŸ“Š Test New API Endpoints (Phase 3B)
        if: success()
        run: |
          echo "Testing Phase 3B endpoints..."
          
          echo "ğŸ“Š Testing /api/stats..."
          curl -f https://dht.afroash.com/api/stats || echo "âš ï¸ Stats endpoint failed"
          
          echo "ğŸ“ˆ Testing /api/history..."
          curl -f https://dht.afroash.com/api/history || echo "âš ï¸ History endpoint failed"
          
          echo "ğŸŒ¡ï¸ Testing /api/current..."
          curl -f https://dht.afroash.com/api/current || echo "âš ï¸ Current endpoint failed"

      - name: ğŸ“Š Show Logs on Failure
        if: failure()
        run: |
          ssh -i ~/.ssh/deploy_key ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} \
            "sudo journalctl -u dht-server -n 50 --no-pager"

      - name: ğŸ‰ Deployment Summary
        if: success()
        run: |
          echo "âœ… Deployment successful!"
          echo ""
          echo "ğŸ“¦ Phase 3B Features Deployed:"
          echo "  â€¢ SQLite persistence layer"
          echo "  â€¢ Historical data navigation"
          echo "  â€¢ Grafana-style dashboard"
          echo ""
          echo "ğŸ”— URLs:"
          echo "  ğŸŒ Dashboard: https://dht.afroash.com"
          echo "  ğŸ¥ Health: https://dht.afroash.com/health"
          echo "  ğŸ“Š Stats: https://dht.afroash.com/api/stats"
          echo "  ğŸ“ˆ History: https://dht.afroash.com/api/history"
          echo ""
          echo "ğŸ—„ï¸ Database:"
          echo "  Location: /var/lib/dht-monitor/dht.db"
          echo "  Retention: 7 days"